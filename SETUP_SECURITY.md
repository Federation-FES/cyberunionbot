# Настройка системы безопасности

## Быстрый старт

### 1. Создайте файл `.env.local`

В корне проекта создайте файл `.env.local` со следующим содержимым:

```env
# Ключ для шифрования персональных данных
# ВАЖНО: Используйте криптографически стойкий ключ длиной минимум 32 символа
VITE_ENCRYPTION_KEY=your-super-secret-encryption-key-32-chars-minimum-change-this!!

# Секрет для подписи платежных запросов
VITE_PAYMENT_SECRET=your-payment-secret-key-change-this-in-production
```

### 2. Генерация безопасных ключей

#### Windows (PowerShell):
```powershell
# Генерация ключа шифрования (32 байта в base64)
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))

# Генерация секрета для платежей
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))
```

#### Linux/Mac:
```bash
# Генерация ключа шифрования
openssl rand -base64 32

# Генерация секрета для платежей
openssl rand -base64 32
```

### 3. Добавьте `.env.local` в `.gitignore`

Убедитесь, что файл `.env.local` добавлен в `.gitignore`:

```
.env.local
.env*.local
```

## Что было реализовано

### ✅ Хеширование паролей
- Пароли хешируются с использованием PBKDF2-SHA256
- Уникальная соль для каждого пароля
- 100,000 итераций для защиты от brute-force атак

### ✅ Шифрование персональных данных
- Имя и телефон шифруются перед сохранением в БД
- Используется AES-GCM 256-bit
- Уникальный IV для каждого шифрования

### ✅ Безопасные сессии
- JWT-подобные токены с истечением срока действия
- Автоматическая проверка валидности
- Срок действия: 7 дней (настраивается)

### ✅ Защита платежей
- Валидация всех платежных данных
- HMAC-SHA256 подписи для защиты от подделки
- Проверка лимитов и сумм

## Использование

### Регистрация пользователя

Код автоматически хеширует пароль и шифрует персональные данные:

```typescript
// В RegisterPage.tsx уже реализовано
// Пароль автоматически хешируется
// Имя и телефон автоматически шифруются
```

### Авторизация

При входе пароль проверяется, а данные расшифровываются:

```typescript
// В LoginPage.tsx уже реализовано
// Автоматическая проверка хеша пароля
// Автоматическая расшифровка персональных данных
```

### Работа с сессиями

Используйте хук `useSession`:

```typescript
import { useSession } from '@/hooks/use-session';

function MyComponent() {
  const { session, isLoading, clearSession } = useSession();
  
  if (isLoading) return <div>Загрузка...</div>;
  if (!session) return <div>Не авторизован</div>;
  
  return <div>Привет, {session.name}!</div>;
}
```

### Защита платежей

Валидация и подписи уже добавлены в `TelegramApp.tsx`:

```typescript
// Автоматическая валидация платежных данных
// Автоматическое создание подписей
// Проверка на сервере (через Edge Function)
```

## Миграция существующих данных

Если у вас уже есть пользователи с незашифрованными данными:

1. **Пароли**: Код поддерживает обратную совместимость. При следующем входе пользователя пароль будет автоматически перехеширован (если реализовать миграцию в Edge Function).

2. **Персональные данные**: Код автоматически пытается расшифровать данные. Если расшифровка не удается (старые данные), используются данные как есть.

Для полной миграции создайте скрипт миграции:

```sql
-- Пример SQL для миграции (выполняется через Edge Function)
-- 1. Хеширование паролей
-- 2. Шифрование персональных данных
```

## Рекомендации для production

### Обязательно:
1. ✅ Используйте разные ключи для dev/staging/production
2. ✅ Никогда не коммитьте ключи в git
3. ✅ Используйте HTTPS только
4. ✅ Настройте RLS (Row Level Security) в Supabase

### Рекомендуется:
1. ⚠️ Перенесите хеширование паролей на сервер (Edge Functions)
2. ⚠️ Добавьте rate limiting для API
3. ⚠️ Настройте мониторинг безопасности
4. ⚠️ Регулярно обновляйте зависимости
5. ⚠️ Проводите аудиты безопасности

## Edge Functions (рекомендуется)

Для максимальной безопасности создайте Edge Functions:

### `supabase/functions/register/index.ts`
```typescript
// Хеширование паролей на сервере
// Шифрование данных на сервере
// Валидация на сервере
```

### `supabase/functions/login/index.ts`
```typescript
// Проверка паролей на сервере
// Расшифровка данных на сервере
// Создание токенов на сервере
```

### `supabase/functions/create-payment/index.ts`
```typescript
// Валидация платежных данных
// Проверка подписей
// Rate limiting
```

## Проверка работы

1. Зарегистрируйте нового пользователя
2. Проверьте в БД, что пароль захеширован (формат: `salt:hash`)
3. Проверьте, что имя и телефон зашифрованы (формат: `iv:encrypted`)
4. Войдите с новым пользователем
5. Убедитесь, что данные корректно расшифровываются

## Поддержка

Если возникли проблемы:
1. Проверьте, что `.env.local` создан и содержит ключи
2. Проверьте консоль браузера на ошибки
3. Убедитесь, что используется HTTPS (для Web Crypto API)

## Дополнительная информация

См. `SECURITY.md` для подробной информации о реализованных мерах безопасности.
