# Решение проблем с системой безопасности

## Частые проблемы и решения

### 1. ❌ Ошибка при регистрации: "Ошибка шифрования данных"

**Причина**: Проблема с Web Crypto API или ключом шифрования

**Решение**:
- Убедитесь, что используете HTTPS (Web Crypto API требует безопасное соединение)
- Проверьте, что `.env.local` содержит `VITE_ENCRYPTION_KEY` (минимум 32 символа)
- Перезапустите dev-сервер после изменения `.env.local`

### 2. ❌ Старые пользователи не могут войти

**Причина**: Старые пароли не захешированы

**Решение**: ✅ **ИСПРАВЛЕНО!** 
- Код теперь автоматически определяет старый формат пароля
- При входе старый пароль автоматически перехешируется
- Старые пользователи могут войти без проблем

### 3. ❌ Ошибка при расшифровке данных

**Причина**: Старые данные не зашифрованы

**Решение**: ✅ **ИСПРАВЛЕНО!**
- Код автоматически определяет, зашифрованы ли данные
- Старые незашифрованные данные используются как есть
- Новые данные автоматически шифруются

### 4. ❌ Переменные окружения не загружаются

**Причина**: Vite не видит `.env.local`

**Решение**:
1. Убедитесь, что `.env.local` находится в **корне проекта** (не в `src/`)
2. Перезапустите dev-сервер (`npm run dev`)
3. Проверьте, что переменные начинаются с `VITE_`
4. Откройте консоль браузера и проверьте: `console.log(import.meta.env.VITE_ENCRYPTION_KEY)`

### 5. ❌ Ошибка "Crypto is not defined" или "crypto.subtle is undefined"

**Причина**: Web Crypto API недоступен

**Решение**:
- **Обязательно используйте HTTPS** (Web Crypto API работает только на безопасных соединениях)
- Для локальной разработки используйте `https://localhost:8080` вместо `http://localhost:8080`
- Настройте SSL-сертификат для локальной разработки или используйте туннель (ngrok, cloudflare tunnel)

### 6. ❌ Платежи не проходят валидацию

**Причина**: Проблема с подписью или валидацией данных

**Решение**:
- Проверьте консоль браузера на ошибки
- Убедитесь, что `VITE_PAYMENT_SECRET` установлен в `.env.local`
- Проверьте, что сумма платежа в допустимых пределах (не больше 100,000 рублей)

### 7. ❌ Сессия истекает слишком быстро

**Причина**: Токен сессии имеет срок действия 7 дней

**Решение**:
- Это нормальное поведение для безопасности
- Пользователь должен войти заново через 7 дней
- Можно изменить срок действия в `src/lib/security.ts` в функции `createSessionToken`

## Проверка работы системы

### Тест 1: Регистрация нового пользователя
1. Зарегистрируйте нового пользователя
2. Проверьте в Supabase таблицу `user_data`:
   - Пароль должен быть в формате: `salt:hash` (оба в base64)
   - Имя должно быть в формате: `iv:encrypted` (оба в base64)
   - Телефон должен быть в формате: `iv:encrypted` (оба в base64)

### Тест 2: Вход нового пользователя
1. Войдите с только что созданным пользователем
2. Проверьте, что данные корректно отображаются (расшифрованы)
3. Проверьте localStorage - должна быть сессия с токеном

### Тест 3: Вход старого пользователя
1. Войдите с пользователем, созданным до внедрения безопасности
2. Должен работать вход (обратная совместимость)
3. После входа пароль должен быть автоматически перехеширован в БД

### Тест 4: Создание платежа
1. Попробуйте создать платеж
2. Проверьте консоль браузера - не должно быть ошибок валидации
3. Проверьте, что запрос содержит подпись

## Отладка

### Включить подробное логирование

Добавьте в начало `src/lib/security.ts`:
```typescript
const DEBUG = import.meta.env.DEV; // true в development

if (DEBUG) {
  console.log('Security module loaded');
  console.log('Encryption key available:', !!import.meta.env.VITE_ENCRYPTION_KEY);
  console.log('Payment secret available:', !!import.meta.env.VITE_PAYMENT_SECRET);
}
```

### Проверить переменные окружения

В консоли браузера:
```javascript
console.log('VITE_ENCRYPTION_KEY:', import.meta.env.VITE_ENCRYPTION_KEY ? 'SET' : 'NOT SET');
console.log('VITE_PAYMENT_SECRET:', import.meta.env.VITE_PAYMENT_SECRET ? 'SET' : 'NOT SET');
```

### Проверить формат данных в БД

В Supabase SQL Editor:
```sql
-- Проверить формат паролей
SELECT 
  id, 
  login,
  CASE 
    WHEN password LIKE '%:%' THEN 'Hashed (new format)'
    ELSE 'Plain text (old format)'
  END as password_format,
  CASE 
    WHEN name LIKE '%:%' THEN 'Encrypted (new format)'
    ELSE 'Plain text (old format)'
  END as name_format
FROM user_data
LIMIT 10;
```

## Получение помощи

Если проблема не решена:
1. Проверьте консоль браузера на ошибки
2. Проверьте консоль сервера (терминал с `npm run dev`)
3. Проверьте Network tab в DevTools - есть ли ошибки запросов
4. Убедитесь, что используете HTTPS
5. Проверьте, что `.env.local` в корне проекта и перезапущен сервер

## Чеклист перед обращением за помощью

- [ ] `.env.local` создан в корне проекта
- [ ] Ключи `VITE_ENCRYPTION_KEY` и `VITE_PAYMENT_SECRET` установлены
- [ ] Dev-сервер перезапущен после создания `.env.local`
- [ ] Используется HTTPS (для Web Crypto API)
- [ ] Проверена консоль браузера на ошибки
- [ ] Проверена консоль сервера на ошибки
