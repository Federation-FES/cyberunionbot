# Руководство по безопасности

## Внедренные меры безопасности

### 1. Хеширование паролей
- **Метод**: PBKDF2 с SHA-256
- **Итерации**: 100,000 (безопасное значение)
- **Соль**: Уникальная для каждого пароля
- **Формат хранения**: `salt:hash` (оба в base64)

Пароли никогда не хранятся в открытом виде. При регистрации пароль хешируется перед сохранением в базу данных.

### 2. Шифрование персональных данных
- **Алгоритм**: AES-GCM 256-bit
- **Защищенные поля**: имя, телефон
- **IV**: Уникальный для каждого шифрования

Персональные данные (имя, телефон) шифруются перед сохранением в базу данных и расшифровываются только при авторизации.

### 3. Безопасные сессии
- **Токены**: JWT-подобные токены с истечением срока действия
- **Срок действия**: 7 дней (настраивается)
- **Проверка**: Автоматическая проверка валидности при каждом использовании

### 4. Защита платежей
- **Валидация данных**: Проверка суммы, тарифов, лимитов
- **Подписи запросов**: HMAC-SHA256 для защиты от подделки
- **Rate limiting**: Рекомендуется добавить на уровне Edge Functions

## Настройка для production

### 1. Переменные окружения

Создайте файл `.env.local` с следующими переменными:

```env
# Ключ для шифрования персональных данных (32+ символов)
VITE_ENCRYPTION_KEY=your-super-secret-encryption-key-32-chars-minimum!!

# Секрет для подписи платежных запросов
VITE_PAYMENT_SECRET=your-payment-secret-key-change-this-in-production
```

**ВАЖНО**: 
- Никогда не коммитьте `.env.local` в git
- Используйте разные ключи для разных окружений
- Генерируйте ключи с помощью криптографически стойкого генератора

### 2. Генерация безопасных ключей

```bash
# Для Linux/Mac
openssl rand -base64 32

# Для Windows (PowerShell)
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))
```

### 3. Edge Functions для дополнительной защиты

Для максимальной безопасности рекомендуется:

1. **Хеширование паролей на сервере**: Создайте Edge Function для регистрации, которая будет хешировать пароли на сервере
2. **Валидация платежей на сервере**: Проверяйте подписи и валидируйте данные в Edge Function
3. **Rate limiting**: Ограничьте количество запросов от одного пользователя

Пример структуры Edge Function для регистрации:

```typescript
// supabase/functions/register/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  const { name, phone, login, password } = await req.json()
  
  // Хеширование на сервере
  const hashedPassword = await hashPasswordOnServer(password)
  
  // Шифрование на сервере
  const encryptedName = await encryptDataOnServer(name)
  const encryptedPhone = await encryptDataOnServer(phone)
  
  // Сохранение в БД
  // ...
})
```

## Рекомендации по безопасности

### Обязательные меры:
1. ✅ Хеширование паролей
2. ✅ Шифрование персональных данных
3. ✅ Токены сессий с истечением
4. ✅ Валидация платежных данных
5. ✅ Подписи платежных запросов

### Дополнительные меры (рекомендуется):
1. ⚠️ HTTPS только (запретить HTTP)
2. ⚠️ Content Security Policy (CSP)
3. ⚠️ Rate limiting на уровне API
4. ⚠️ Логирование подозрительной активности
5. ⚠️ Двухфакторная аутентификация (2FA)
6. ⚠️ Мониторинг безопасности
7. ⚠️ Регулярные аудиты безопасности

### Защита от атак:
- **SQL Injection**: Защищено Supabase (параметризованные запросы)
- **XSS**: React автоматически экранирует данные
- **CSRF**: Используйте токены для критических операций
- **Timing Attacks**: Постоянное время сравнения хешей
- **Man-in-the-Middle**: HTTPS обязателен

## Миграция существующих данных

Если у вас уже есть пользователи с незашифрованными данными:

1. Создайте миграцию для хеширования паролей
2. Обновите код для поддержки старых и новых форматов
3. Постепенно мигрируйте данные при следующем входе пользователя

Пример обработки старых паролей:

```typescript
// В LoginPage уже реализована обратная совместимость
// для расшифровки данных - если расшифровка не удалась,
// используются данные как есть
```

## Аудит безопасности

Регулярно проверяйте:
- [ ] Обновлены ли зависимости
- [ ] Используются ли актуальные алгоритмы шифрования
- [ ] Не скомпрометированы ли ключи
- [ ] Работает ли HTTPS
- [ ] Настроены ли правильные CORS политики
- [ ] Включен ли RLS (Row Level Security) в Supabase

## Контакты для сообщений об уязвимостях

Если вы обнаружили уязвимость, пожалуйста, сообщите об этом ответственно.
